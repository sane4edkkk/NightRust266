<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заказ сервера - GameHosting</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="/" class="logo">GameHosting</a>
            <nav class="nav">
                <a href="/" class="nav-link">Главная</a>
                <a href="/servers" class="nav-link">Мои серверы</a>
                <a href="/balance" class="nav-link">Баланс</a>
                <div class="user-info">
                    <span id="username">Загрузка...</span>
                    <span id="balance" class="balance">0 ₽</span>
                </div>
            </nav>
        </div>
    </header>

    <section class="order-section">
        <div class="container">
            <div class="order-card">
                <div class="order-header">
                    <h1>Заказ сервера CS2</h1>
                    <div class="game-icon">
                        <img src="images/cs2-icon.png" alt="CS2" width="48" height="48">
                    </div>
                </div>

                <div class="price-calculator">
                    <div class="calculator-item">
                        <label for="slots">Количество слотов</label>
                        <select id="slots" onchange="calculatePrice()">
                            <option value="12">12 слотов</option>
                            <option value="20">20 слотов</option>
                            <option value="32">32 слота</option>
                            <option value="64">64 слота</option>
                        </select>
                    </div>

                    <div class="calculator-item">
                        <label for="location">Локация</label>
                        <select id="location" onchange="calculatePrice()">
                            <option value="msk">Москва</option>
                            <option value="spb">Санкт-Петербург</option>
                            <option value="kzn">Казань</option>
                        </select>
                    </div>

                    <div class="calculator-item">
                        <label for="period">Период оплаты</label>
                        <select id="period" onchange="calculatePrice()">
                            <option value="1">1 месяц</option>
                            <option value="3">3 месяца (-10%)</option>
                            <option value="6">6 месяцев (-20%)</option>
                            <option value="12">12 месяцев (-30%)</option>
                        </select>
                    </div>

                    <div class="calculator-item">
                        <label for="tickrate">Тикрейт</label>
                        <select id="tickrate" onchange="calculatePrice()">
                            <option value="64">64 тик</option>
                            <option value="128">128 тик (+20%)</option>
                        </select>
                    </div>
                </div>

                <div class="server-features">
                    <h3>Включено в стоимость:</h3>
                    <ul class="features-list">
                        <li>
                            <span class="material-icons">security</span>
                            <span>Защита от DDoS-атак</span>
                        </li>
                        <li>
                            <span class="material-icons">storage</span>
                            <span>SSD-диски</span>
                        </li>
                        <li>
                            <span class="material-icons">backup</span>
                            <span>Ежедневные бэкапы</span>
                        </li>
                        <li>
                            <span class="material-icons">dns</span>
                            <span>Выделенный IP-адрес</span>
                        </li>
                    </ul>
                </div>

                <div class="order-summary">
                    <div class="total-price">
                        Итого: <span id="totalPrice">1200</span> ₽/мес
                    </div>
                    <button class="btn btn-primary" onclick="placeOrder()">
                        <span class="material-icons">shopping_cart</span>
                        Заказать сервер
                    </button>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('username').textContent = user.username;
                    document.getElementById('balance').textContent = `${user.balance} ₽`;
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }

            calculatePrice();
        });

        function calculatePrice() {
            const slots = parseInt(document.getElementById('slots').value);
            const period = parseInt(document.getElementById('period').value);
            const tickrate = parseInt(document.getElementById('tickrate').value);
            
            let basePrice = slots * 100; // 100 рублей за слот
            
            // Наценка за тикрейт
            if (tickrate === 128) {
                basePrice *= 1.2;
            }
            
            // Скидка за период
            let discount = 0;
            switch(period) {
                case 3: discount = 0.1; break;
                case 6: discount = 0.2; break;
                case 12: discount = 0.3; break;
            }
            
            const finalPrice = Math.round(basePrice * (1 - discount));
            document.getElementById('totalPrice').textContent = finalPrice;
        }

        async function placeOrder() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Необходимо войти в систему');
                return;
            }

            const orderData = {
                game: 'cs2',
                slots: parseInt(document.getElementById('slots').value),
                location: document.getElementById('location').value,
                period: parseInt(document.getElementById('period').value),
                tickrate: parseInt(document.getElementById('tickrate').value),
                price: parseInt(document.getElementById('totalPrice').textContent)
            };

            try {
                const response = await fetch('/api/servers/order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Сервер успешно заказан!');
                    window.location.href = '/servers';
                } else {
                    const error = await response.json();
                    alert(error.message);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при заказе сервера');
            }
        }
    </script>
</body>
</html> 